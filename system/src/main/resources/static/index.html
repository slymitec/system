<!DOCTYPE HTML>
<html lang="en">
<head>
    <title>SLY System</title>
</head>

<body>
<div style="width: 100px"><label for="processID">processID </label></div>
<input id="processID" type="text" style="width: 500px; height: 20px" value="9c337a14-f7f4-432e-ab4a-c8e95943d31f"/><br/>
<div style="width: 100px"><label for="task">task </label></div>
<select id="task" style="width: 500px; height: 20px">
    <option value="HandleAction">HandleAction</option>
    <option value="FactoryManager">FactoryManager</option>
    <option value="ObjectManager">ObjectManager</option>
    <option value="ProcessManager">ProcessManager</option>
    <option value="UserManager">UserManager</option>
</select><br/>
<div style="width: 100px"><label for="method">method </label></div>
<input id="method" type="text" style="width: 500px; height: 20px" value="getAllHandles"/><br/>
<div style="width: 100px"><label for="request">request </label></div>
<input id="request" type="text" style="width: 100%; height: 60px; font-size: 24px" value="{}"/><br/>
<button onclick="send()" style="width: 200px; height: 40px">发送</button>
<button onclick="createWebSocket()" style="width: 200px; height: 40px">连接</button>
<button onclick="closeWebSocket()" style="width: 200px; height: 40px">断开</button>
<button onclick="clearScreen()" style="width: 200px; height: 40px">清屏</button>
<button onclick="send2()" style="width: 200px; height: 40px">传统发送</button>
<div id="message"></div>
</body>

<script type="text/javascript">
    const hostAddress = "localhost:8080";

    function send() {
        const processID = document.getElementById('processID').value;
        const task = document.getElementById('task').value;
        const method = document.getElementById('method').value;
        const request = document.getElementById('request').value;

        let userContextRequestRaw = {
            "processID": {"id": processID},
            "content": {
                "id": "00000000-0000-0000-0000-000000000000",
                "task": task,
                "method": method,
                "request": JSON.parse(request)
            }
        };

        let userContextRequest = JSON.stringify(userContextRequestRaw);

        setMessageInnerHTML("输入：" + userContextRequest + newline);
        websocket.send(userContextRequest);
    }

    function setMessageInnerHTML(innerHTML) {
        const text = document.getElementById('message').innerHTML;
        document.getElementById('message').innerHTML = innerHTML + newline + text;
    }

    let websocket = null;
    let newline = "<br/>";

    function createWebSocket() {
        if (websocket != null) {
            return;
        }

        if ('WebSocket' in window) {
            websocket = new WebSocket("ws://" + hostAddress + "/Call.action");
            setMessageInnerHTML("--连接中--");
        } else {
            alert('浏览器不支持……')
        }

        websocket.onmessage = function (event) {
            let userContentResponse = JSON.parse(event.data);

            console.log(event.data);
            console.log(userContentResponse);

            let responseRaw = "";
            for (const key in userContentResponse.result) {
                let value = userContentResponse.result[key];

                responseRaw = responseRaw + "->" + key + " : " + JSON.stringify(value) + newline;
            }

            let exceptionRaw = "";
            for (const key in userContentResponse.exception) {
                let value = userContentResponse.exception[key];

                exceptionRaw = exceptionRaw + "->" + key + " : " + JSON.stringify(value) + newline;
            }

            setMessageInnerHTML("输出：" + newline + "result:" + newline + responseRaw + "exception:" + newline + exceptionRaw);
        }

        websocket.onerror = function () {
            setMessageInnerHTML("--错误--");
        };

        websocket.onopen = function (event) {
            setMessageInnerHTML("--连接--");
        }

        websocket.onclose = function () {
            setMessageInnerHTML("--关闭--");
        }

        window.onbeforeunload = function () {
            websocket.close();
        }
    }

    function closeWebSocket() {
        if (websocket == null) {
            return;
        }

        websocket.close();

        websocket = null;
    }

    function clearScreen() {
        document.getElementById('message').innerHTML = "";
    }

    function send2() {
        const processID = document.getElementById('processID').value;
        const task = document.getElementById('task').value;
        const method = document.getElementById('method').value;
        const request = document.getElementById('request').value;

        let userContextRequestRaw = {
            "processID": {"id": processID},
            "content": {
                "id": "00000000-0000-0000-0000-000000000000",
                "task": task,
                "method": method,
                "request": JSON.parse(request)
            }
        };

        let userContextRequest = JSON.stringify(userContextRequestRaw);

        setMessageInnerHTML("输入：" + userContextRequest + newline);

        const xmlHttpRequest = new XMLHttpRequest()
        xmlHttpRequest.onreadystatechange = function () {
            if (xmlHttpRequest.readyState === 4 && xmlHttpRequest.status === 200) {
                let userContentResponse = JSON.parse(this.responseText);

                console.log(this.responseText);
                console.log(userContentResponse);

                let responseRaw = "";
                for (const key in userContentResponse.result) {
                    let value = userContentResponse.result[key];

                    responseRaw = responseRaw + "->" + key + " : " + JSON.stringify(value) + newline;
                }

                let exceptionRaw = "";
                for (const key in userContentResponse.exception) {
                    let value = userContentResponse.exception[key];

                    exceptionRaw = exceptionRaw + "->" + key + " : " + JSON.stringify(value) + newline;
                }

                setMessageInnerHTML("输出：" + newline + "result:" + newline + responseRaw + "exception:" + newline + exceptionRaw);
            }
        }

        xmlHttpRequest.open("post", "http://" + hostAddress + "/Request.action");
        xmlHttpRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xmlHttpRequest.send("message=" + userContextRequest);
    }
</script>
</html>